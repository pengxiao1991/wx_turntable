(function(){var t,e,n,s,i={}.hasOwnProperty,o=[].slice;t={LF:"\n",NULL:"\x00"},n=function(){function e(t,e,n){this.command=t,this.headers=null!=e?e:{},this.body=null!=n?n:""}var n;return e.prototype.toString=function(){var n,s,o,r,c;n=[this.command],o=this.headers["content-length"]===!1?!0:!1,o&&delete this.headers["content-length"],c=this.headers;for(s in c)i.call(c,s)&&(r=c[s],n.push(""+s+":"+r));return this.body&&!o&&n.push("content-length:"+e.sizeOfUTF8(this.body)),n.push(t.LF+this.body),n.join(t.LF)},e.sizeOfUTF8=function(t){return t?encodeURI(t).match(/%..|./g).length:0},n=function(n){var s,i,o,r,c,a,u,h,d,l,p,f,g,b,m,v,C;for(r=n.search(RegExp(""+t.LF+t.LF)),c=n.substring(0,r).split(t.LF),o=c.shift(),a={},f=function(t){return t.replace(/^\s+|\s+$/g,"")},v=c.reverse(),g=0,m=v.length;m>g;g++)l=v[g],h=l.indexOf(":"),a[f(l.substring(0,h))]=f(l.substring(h+1));if(s="",p=r+2,a["content-length"])d=parseInt(a["content-length"]),s=(""+n).substring(p,p+d);else for(i=null,u=b=p,C=n.length;(C>=p?C>b:b>C)&&(i=n.charAt(u),i!==t.NULL);u=C>=p?++b:--b)s+=i;return new e(o,a,s)},e.unmarshall=function(e){var s,i,o,r;return i=e.split(RegExp(""+t.NULL+t.LF+"*")),r={frames:[],partial:""},r.frames=function(){var t,e,o,r;for(o=i.slice(0,-1),r=[],t=0,e=o.length;e>t;t++)s=o[t],r.push(n(s));return r}(),o=i.slice(-1)[0],o===t.LF||-1!==o.search(RegExp(""+t.NULL+t.LF+"*$"))?r.frames.push(n(o)):r.partial=o,r},e.marshall=function(n,s,i){var o;return o=new e(n,s,i),o.toString()+t.NULL},e}(),e=function(){function e(t){this.ws=t,this.ws.binaryType="arraybuffer",this.counter=0,this.connected=!1,this.heartbeat={outgoing:1e4,incoming:1e4},this.maxWebSocketFrameSize=16384,this.subscriptions={},this.partialData=""}var i;return e.prototype.debug=function(t){var e;return"undefined"!=typeof window&&null!==window&&null!=(e=window.console)?e.log(t):void 0},i=function(){return Date.now?Date.now():(new Date).valueOf},e.prototype._transmit=function(t,e,s){var i;for(i=n.marshall(t,e,s),"function"==typeof this.debug&&this.debug(">>> "+i);;){if(!(i.length>this.maxWebSocketFrameSize))return this.ws.send(i);this.ws.send(i.substring(0,this.maxWebSocketFrameSize)),i=i.substring(this.maxWebSocketFrameSize),"function"==typeof this.debug&&this.debug("remaining = "+i.length)}},e.prototype._setupHeartbeat=function(e){var n,o,r,c,a,u;if((a=e.version)===s.VERSIONS.V1_1||a===s.VERSIONS.V1_2)return u=function(){var t,n,s,i;for(s=e["heart-beat"].split(","),i=[],t=0,n=s.length;n>t;t++)c=s[t],i.push(parseInt(c));return i}(),o=u[0],n=u[1],0!==this.heartbeat.outgoing&&0!==n&&(r=Math.max(this.heartbeat.outgoing,n),"function"==typeof this.debug&&this.debug("send PING every "+r+"ms"),this.pinger=s.setInterval(r,function(e){return function(){return e.ws.send(t.LF),"function"==typeof e.debug?e.debug(">>> PING"):void 0}}(this))),0!==this.heartbeat.incoming&&0!==o?(r=Math.max(this.heartbeat.incoming,o),"function"==typeof this.debug&&this.debug("check PONG every "+r+"ms"),this.ponger=s.setInterval(r,function(t){return function(){var e;return e=i()-t.serverActivity,e>2*r?("function"==typeof t.debug&&t.debug("did not receive server activity for the last "+e+"ms"),t.ws.close()):void 0}}(this))):void 0},e.prototype._parseConnect=function(){var t,e,n,s;switch(t=1<=arguments.length?o.call(arguments,0):[],s={},t.length){case 2:s=t[0],e=t[1];break;case 3:t[1]instanceof Function?(s=t[0],e=t[1],n=t[2]):(s.login=t[0],s.passcode=t[1],e=t[2]);break;case 4:s.login=t[0],s.passcode=t[1],e=t[2],n=t[3];break;default:s.login=t[0],s.passcode=t[1],e=t[2],n=t[3],s.host=t[4]}return[s,e,n]},e.prototype.connect=function(){var e,r,c,a;return e=1<=arguments.length?o.call(arguments,0):[],a=this._parseConnect.apply(this,e),c=a[0],this.connectCallback=a[1],r=a[2],"function"==typeof this.debug&&this.debug("Opening Web Socket..."),this.ws.onmessage=function(e){return function(s){var o,c,a,u,h,d,l,p,f,g,b,m,v;if(u="undefined"!=typeof ArrayBuffer&&s.data instanceof ArrayBuffer?(o=new Uint8Array(s.data),"function"==typeof e.debug?e.debug("--- got data length: "+o.length):void 0,function(){var t,e,n;for(n=[],t=0,e=o.length;e>t;t++)c=o[t],n.push(String.fromCharCode(c));return n}().join("")):s.data,e.serverActivity=i(),u===t.LF)return void("function"==typeof e.debug&&e.debug("<<< PONG"));for("function"==typeof e.debug&&e.debug("<<< "+u),f=n.unmarshall(e.partialData+u),e.partialData=f.partial,m=f.frames,v=[],g=0,b=m.length;b>g;g++)switch(h=m[g],h.command){case"CONNECTED":"function"==typeof e.debug&&e.debug("connected to server "+h.headers.server),e.connected=!0,e._setupHeartbeat(h.headers),v.push("function"==typeof e.connectCallback?e.connectCallback(h):void 0);break;case"MESSAGE":p=h.headers.subscription,l=e.subscriptions[p]||e.onreceive,l?(a=e,d=h.headers["message-id"],h.ack=function(t){return null==t&&(t={}),a.ack(d,p,t)},h.nack=function(t){return null==t&&(t={}),a.nack(d,p,t)},v.push(l(h))):v.push("function"==typeof e.debug?e.debug("Unhandled received MESSAGE: "+h):void 0);break;case"RECEIPT":v.push("function"==typeof e.onreceipt?e.onreceipt(h):void 0);break;case"ERROR":v.push("function"==typeof r?r(h):void 0);break;default:v.push("function"==typeof e.debug?e.debug("Unhandled frame: "+h):void 0)}return v}}(this),this.ws.onclose=function(t){return function(){var e;return e="Whoops! Lost connection to "+t.ws.url,"function"==typeof t.debug&&t.debug(e),t._cleanUp(),"function"==typeof r?r(e):void 0}}(this),this.ws.onopen=function(t){return function(){return"function"==typeof t.debug&&t.debug("Web Socket Opened..."),c["accept-version"]=s.VERSIONS.supportedVersions(),c["heart-beat"]=[t.heartbeat.outgoing,t.heartbeat.incoming].join(","),t._transmit("CONNECT",c)}}(this)},e.prototype.disconnect=function(t,e){return null==e&&(e={}),this._transmit("DISCONNECT",e),this.ws.onclose=null,this.ws.close(),this._cleanUp(),"function"==typeof t?t():void 0},e.prototype._cleanUp=function(){return this.connected=!1,this.pinger&&s.clearInterval(this.pinger),this.ponger?s.clearInterval(this.ponger):void 0},e.prototype.send=function(t,e,n){return null==e&&(e={}),null==n&&(n=""),e.destination=t,this._transmit("SEND",e,n)},e.prototype.subscribe=function(t,e,n){var s;return null==n&&(n={}),n.id||(n.id="sub-"+this.counter++),n.destination=t,this.subscriptions[n.id]=e,this._transmit("SUBSCRIBE",n),s=this,{id:n.id,unsubscribe:function(){return s.unsubscribe(n.id)}}},e.prototype.unsubscribe=function(t){return delete this.subscriptions[t],this._transmit("UNSUBSCRIBE",{id:t})},e.prototype.begin=function(t){var e,n;return n=t||"tx-"+this.counter++,this._transmit("BEGIN",{transaction:n}),e=this,{id:n,commit:function(){return e.commit(n)},abort:function(){return e.abort(n)}}},e.prototype.commit=function(t){return this._transmit("COMMIT",{transaction:t})},e.prototype.abort=function(t){return this._transmit("ABORT",{transaction:t})},e.prototype.ack=function(t,e,n){return null==n&&(n={}),n["message-id"]=t,n.subscription=e,this._transmit("ACK",n)},e.prototype.nack=function(t,e,n){return null==n&&(n={}),n["message-id"]=t,n.subscription=e,this._transmit("NACK",n)},e}(),s={VERSIONS:{V1_0:"1.0",V1_1:"1.1",V1_2:"1.2",supportedVersions:function(){return"1.1,1.0"}},client:function(t,n){var i,o;return null==n&&(n=["v10.stomp","v11.stomp"]),i=s.WebSocketClass||WebSocket,o=new i(t,n),new e(o)},over:function(t){return new e(t)},Frame:n},s.setInterval=function(t,e){return window.setInterval(e,t)},s.clearInterval=function(t){return window.clearInterval(t)},window.Stomp=s}).call(this),function(){function t(){}window.StompWebSocket=t,t.UN_INIT=0,t.INITING=1,t.CONNECTED=2,t.CONNECT_ERROR=3,t.SERVER_REQUIRE_ARGS={i:"",phv:"",osv:"",cv:"",op:"",nt:"",sdkv:"",fver:""},t.MESSAGE_ID_PREFIEX=(+new Date+"").substring(7),t.failConnectRetryTime=0,t.status=0,t.messageAddedNum=100,t.getMessageId=function(){return this.messageAddedNum+=1,this.MESSAGE_ID_PREFIEX+this.messageAddedNum},t.mark=function(t){this.status=t},t.isConnected=function(){return this.status===this.CONNECTED},t.initial=function(t,e,n,s,i,o,r,c){this.disConnect(),this.NetWorkExceptionHandler=t,this.CommonExceptionHandler=n,this.SocketConnected=s,this.CheckLoginServer=i,this.AUTH_LINK_URL_PREFIX=o,this.UN_AUTH_LINK_URL=r,this.SERVER_DOMAIN=c,this.COMMON_CODES=e},t.disConnect=function(){this.stomp&&(this.stomp.disconnect(),delete this.stomp),this.mark(this.UN_INIT),this.Callbacks={},this.ListenBroadCast=[],this.waitForConnected=[],this.failConnectRetryTime=0,this.lastConnectArguments=null,this.NetWorkExceptionHandler=null},t.connect=function(t,e){var n,s=this;n=t?this.AUTH_LINK_URL_PREFIX+"?access_token="+t:this.UN_AUTH_LINK_URL+"?_=1",e=e||{};for(var i in this.SERVER_REQUIRE_ARGS)e[i]=e[i]||this.SERVER_REQUIRE_ARGS[i],n+="&"+i+"="+e[i];this.lastConnectArguments={token:t,args:e},this.mark(this.INITING),t?(this.sockedIsAuth=!0,this.CheckLoginServer(t,e,function(){s.stomp=Stomp.client(n,null),s.stomp.debug=null,s.stomp.connect({},s.onConnected.bind(s),s.onConnectError.bind(s))})):(this.sockedIsAuth=!1,this.stomp=Stomp.client(n,null),this.stomp.debug=null,this.stomp.connect({},this.onConnected.bind(this),this.onConnectError.bind(this)))},t.sendMessage=function(t,e,n){var s=this.getMessageId();this.Callbacks[s]=n,this.invoke(s,t,e)},t.addBroadCastLiseners=function(t){this.ListenBroadCast.push(t)},t.checkLoginWithXhr=function(t,e,n){Pxfetch.pxfetch({type:"get",url:this.SERVER_DOMAIN+"/native/auth/user/info.do?access_token="+t,data:e,success:function(t){200==t.code?n():console.log("error",t.message)}},5e3)},t.onConnectError=function(t){this.failConnectRetryTime+=1,this.failConnectRetryTime>=3?(console.log("onConnectError todo retry 3 times"),this.mark(this.CONNECT_ERROR),this.NetWorkExceptionHandler&&this.NetWorkExceptionHandler()):(console.log("retry socket"),this.stomp&&(this.stomp.disconnect(),delete this.stomp),this.connect(this.lastConnectArguments.token,this.lastConnectArguments.args))},t.onConnected=function(t){var e=this;this.failConnectRetryTime=0,this.mark(this.CONNECTED),this.stomp.subscribe("/user/queue/resp",this.subscribeUserQueueResp.bind(this)),this.stomp.subscribe("/topic/roulette",this.subscribeBroadcast.bind(this)),this.SocketConnected(this.sockedIsAuth),this.waitForConnected.forEach(function(t){e.stomp.send(t.reqKey,{"message-id":t.msgid},t.message)}),this.waitForConnected=[]},t.subscribeBroadcast=function(t){var e=JSON.parse(t.body);this.ListenBroadCast.forEach(function(t){t(e)})},t.subscribeUserQueueResp=function(t){var n=JSON.parse(t.body),s=n.respFor,i=this.Callbacks[s];return this.COMMON_CODES&&this.COMMON_CODES.hasOwnProperty(n.code)?(this.CommonExceptionHandler(n),void delete this.Callbacks[s]):(e&&e(n),void(i&&(delete this.Callbacks[s],i(n))))};var e=null;t.globalSubscriSuccess=function(t){e=t},t.invoke=function(t,e,n){this.isConnected()?this.stomp.send(e,{"message-id":t},n):this.waitForConnected.push({reqKey:e,msgid:t,message:n})}}();